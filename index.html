<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>QuestFocus</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Plus Jakarta Sans', 'sans-serif'],
            },
            animation: {
              'blob': 'blob 10s infinite',
              'float': 'float 6s ease-in-out infinite',
            },
            keyframes: {
              blob: {
                '0%': { transform: 'translate(0px, 0px) scale(1)' },
                '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                '100%': { transform: 'translate(0px, 0px) scale(1)' },
              },
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-10px)' },
              }
            }
          }
        }
      }
    </script>

    <style>
      :root {
        --blob-1: #4f46e5;
        --blob-2: #db2777;
        --blob-3: #06b6d4;
      }

      body {
        font-family: 'Plus Jakarta Sans', sans-serif;
        overflow-x: hidden;
        /* Prevent pull-to-refresh on mobile */
        overscroll-behavior-y: none; 
      }

      /* Liquid Background */
      .bg-liquid-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
        overflow: hidden;
        transition: background-color 0.5s ease;
      }
      
      .blob {
        position: absolute;
        filter: blur(80px);
        opacity: 0.6;
        border-radius: 50%;
        animation: blob 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        transition: background-color 1s ease;
      }

      /* Glassmorphism Styles (iOS 26 Concept) */
      .glass-base {
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
      }

      .dark .glass-base {
        background: rgba(20, 20, 30, 0.6);
        border-color: rgba(255, 255, 255, 0.08);
      }

      .light .glass-base {
        background: rgba(255, 255, 255, 0.65);
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 8px 32px 0 rgba(100, 100, 111, 0.1);
      }

      /* Card Glass */
      .glass-card {
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .glass-card:active {
        transform: scale(0.98);
      }
      
      .dark .glass-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .dark .glass-card:hover {
        background: rgba(255, 255, 255, 0.07);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .light .glass-card {
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      .light .glass-card:hover {
        background: rgba(255, 255, 255, 0.7);
        transform: translateY(-2px);
      }

      /* Scrollbar */
      ::-webkit-scrollbar { width: 4px; height: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.3); border-radius: 10px; }
      
      /* Toggle Switch */
      .toggle-checkbox:checked {
        right: 0;
        border-color: #68D391;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #68D391;
      }
      
      /* Dragging styles */
      .dragging {
        opacity: 0.5;
        transform: scale(1.05) rotate(2deg);
      }
      
      /* Loader */
      .loader {
        border: 3px solid rgba(255,255,255,0.1);
        border-radius: 50%;
        border-top: 3px solid #6366f1;
        width: 24px;
        height: 24px;
        -webkit-animation: spin 1s linear infinite; /* Safari */
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body class="text-slate-900 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      
      // --- IndexedDB Helper ---
      const DB_NAME = 'QuestFocusDB';
      const DB_VERSION = 1;
      const STORE_NAME = 'appData';

      const idb = {
        db: null,
        initPromise: null,

        async init() {
          if (this.initPromise) return this.initPromise;

          this.initPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = (event) => {
              console.error("IndexedDB error:", event.target.error);
              reject("IndexedDB error: " + event.target.error);
            };
            
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
              }
            };
            
            request.onsuccess = (event) => {
              this.db = event.target.result;
              resolve(this.db);
            };
          });
          return this.initPromise;
        },
        
        async get(key) {
          await this.init();
          return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized");
            const transaction = this.db.transaction([STORE_NAME], "readonly");
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(key);
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        },
        
        async set(key, value) {
          await this.init();
          return new Promise((resolve, reject) => {
             if (!this.db) return reject("Database not initialized");
            const transaction = this.db.transaction([STORE_NAME], "readwrite");
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put(value, key);
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        }
      };

      // --- Icons ---
      const Icon = ({ children, size = 24, className = "", ...props }) => (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width={size} 
          height={size} 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          strokeWidth="2" 
          strokeLinecap="round" 
          strokeLinejoin="round" 
          className={`lucide ${className}`}
          {...props}
        >
          {children}
        </svg>
      );

      const CheckCircle2 = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></Icon>;
      const Circle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/></Icon>;
      const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
      const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
      const Pause = (props) => <Icon {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></Icon>;
      const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
      const Trophy = (props) => <Icon {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></Icon>;
      const ShoppingBag = (props) => <Icon {...props}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>;
      const Layers = (props) => <Icon {...props}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></Icon>;
      const Moon = (props) => <Icon {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></Icon>;
      const Sun = (props) => <Icon {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></Icon>;
      const Calendar = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
      const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
      const Flame = (props) => <Icon {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.113.434-2.154 1.157-2.922"/></Icon>;
      const Zap = (props) => <Icon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>;
      const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></Icon>;

      // --- Types & Constants ---
      
      const LEVELS = [0, 500, 1200, 2500, 5000, 10000];
      
      const ITEMS_DB = [
        { id: 'theme_default', type: 'theme', name: 'Cosmic Night', cost: 0, colors: ['#4f46e5', '#db2777', '#06b6d4'], unlocked: true },
        { id: 'theme_forest', type: 'theme', name: 'Zen Forest', cost: 500, colors: ['#166534', '#84cc16', '#14b8a6'], unlocked: false },
        { id: 'theme_sunset', type: 'theme', name: 'Miami Sunset', cost: 1000, colors: ['#c026d3', '#f59e0b', '#f43f5e'], unlocked: false },
        { id: 'theme_ocean', type: 'theme', name: 'Deep Ocean', cost: 2000, colors: ['#1e3a8a', '#3b82f6', '#0ea5e9'], unlocked: false },
        { id: 'effect_fire', type: 'effect', name: 'Fire Confetti', cost: 1500, config: { colors: ['#ef4444', '#f59e0b'] }, unlocked: false },
        { id: 'effect_gold', type: 'effect', name: 'Gold Rain', cost: 3000, config: { colors: ['#eab308', '#facc15', '#fff'] }, unlocked: false },
      ];

      // --- Helper Functions ---
      
      const formatTime = (seconds) => {
        if (!seconds) return "00:00";
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      };

      const getDifficultyColor = (priority) => {
        switch(priority) {
          case 'HIGH': return 'text-red-400 bg-red-400/10 border-red-400/20';
          case 'MEDIUM': return 'text-amber-400 bg-amber-400/10 border-amber-400/20';
          default: return 'text-emerald-400 bg-emerald-400/10 border-emerald-400/20';
        }
      };

      // --- Components ---

      const Layout = ({ children, darkMode, setDarkMode, user, equippedTheme, isLoading }) => {
        const colors = equippedTheme && equippedTheme.colors ? equippedTheme.colors : ['#4f46e5', '#db2777', '#06b6d4'];

        if (isLoading) {
           return (
             <div className="h-screen w-screen flex flex-col items-center justify-center bg-slate-900 text-white gap-4">
               <div className="loader"></div>
               <p className="animate-pulse text-sm font-mono">Loading Quest Data...</p>
             </div>
           );
        }

        return (
          <div className={darkMode ? 'dark' : 'light'}>
            <div className="bg-liquid-container bg-slate-100 dark:bg-[#0f172a]">
              <div className="blob blob-1 top-[-10%] left-[-10%] w-[50vw] h-[50vw]" style={{background: colors[0]}}></div>
              <div className="blob blob-2 bottom-[-10%] right-[-10%] w-[60vw] h-[60vw]" style={{background: colors[1]}}></div>
              <div className="blob blob-3 top-[40%] left-[40%] w-[40vw] h-[40vw]" style={{background: colors[2]}}></div>
            </div>
            
            <div className="relative z-10 min-h-screen flex flex-col max-w-4xl mx-auto px-4 pb-24 md:pb-6 pt-4 md:pt-8">
              {/* Header */}
              <header className="glass-base rounded-3xl p-4 mb-6 flex justify-between items-center animate-float">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                    Q
                  </div>
                  <div>
                    <h1 className="font-bold text-lg leading-tight dark:text-white text-slate-800">QuestFocus</h1>
                    <div className="flex items-center gap-2 text-xs font-mono opacity-60 dark:text-white text-slate-600">
                      <span>Lvl {user.level}</span>
                      <span className="w-1 h-1 rounded-full bg-current"></span>
                      <span>{user.xp} XP</span>
                      <span className="w-1 h-1 rounded-full bg-current"></span>
                      <span className="text-amber-500 font-bold">${user.credits}</span>
                    </div>
                  </div>
                </div>
                
                <button 
                  onClick={() => setDarkMode(!darkMode)}
                  className="p-3 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
                >
                  {darkMode ? <Sun size={20} className="text-amber-300" /> : <Moon size={20} className="text-slate-600" />}
                </button>
              </header>

              {children}
            </div>
          </div>
        );
      };

      const TaskCard = ({ task, onMove, onUpdate, onDelete, onComplete }) => {
        const [elapsed, setElapsed] = useState(task.elapsedTime || 0);

        useEffect(() => {
          let interval;
          if (task.isTimerRunning) {
            interval = setInterval(() => {
              const sessionTime = Math.floor((Date.now() - task.lastStartedAt) / 1000);
              setElapsed((task.elapsedTime || 0) + sessionTime);
            }, 1000);
          } else {
            setElapsed(task.elapsedTime || 0);
          }
          return () => clearInterval(interval);
        }, [task.isTimerRunning, task.lastStartedAt, task.elapsedTime]);

        const toggleTimer = (e) => {
          e.stopPropagation();
          const now = Date.now();
          if (task.isTimerRunning) {
            const sessionTime = Math.floor((now - task.lastStartedAt) / 1000);
            onUpdate(task.id, {
              isTimerRunning: false,
              elapsedTime: (task.elapsedTime || 0) + sessionTime,
              lastStartedAt: null
            });
          } else {
            onUpdate(task.id, {
              isTimerRunning: true,
              lastStartedAt: now,
            });
          }
        };

        const handleDragStart = (e) => {
          e.dataTransfer.setData("taskId", task.id);
          e.currentTarget.classList.add('dragging');
        };

        const handleDragEnd = (e) => {
          e.currentTarget.classList.remove('dragging');
        };

        return (
          <div 
            draggable 
            onDragStart={handleDragStart}
            onDragEnd={handleDragEnd}
            className="glass-card rounded-2xl p-4 mb-3 cursor-grab active:cursor-grabbing group relative overflow-hidden"
          >
            <div className={`absolute left-0 top-0 bottom-0 w-1 ${task.status === 'DONE' ? 'bg-emerald-500' : task.status === 'IN_PROGRESS' ? 'bg-indigo-500' : 'bg-slate-400/30'}`}></div>

            <div className="pl-3">
              <div className="flex justify-between items-start mb-2">
                <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${getDifficultyColor(task.priority)}`}>
                  {task.priority}
                </span>
                {task.targetDate && (
                  <span className="text-[10px] flex items-center gap-1 opacity-50 dark:text-white text-slate-600">
                    <Calendar size={10} /> {new Date(task.targetDate).toLocaleDateString()}
                  </span>
                )}
              </div>

              <h3 className={`font-semibold mb-3 ${task.status === 'DONE' ? 'line-through opacity-50' : ''} dark:text-white text-slate-800`}>
                {task.title}
              </h3>

              <div className="flex items-center justify-between">
                {task.status !== 'DONE' ? (
                  <button 
                    onClick={toggleTimer}
                    className={`flex items-center gap-2 px-3 py-1.5 rounded-xl text-xs font-bold transition-all ${
                      task.isTimerRunning 
                      ? 'bg-amber-500/20 text-amber-500 border border-amber-500/30 animate-pulse' 
                      : 'bg-slate-500/10 dark:bg-white/5 text-slate-500 dark:text-slate-400 hover:bg-slate-500/20'
                    }`}
                  >
                    {task.isTimerRunning ? <Pause size={12} fill="currentColor" /> : <Play size={12} fill="currentColor" />}
                    {formatTime(elapsed)}
                  </button>
                ) : (
                   <span className="text-xs font-mono opacity-50 flex items-center gap-1 dark:text-white text-slate-600">
                      <Clock size={12} /> {formatTime(elapsed)}
                   </span>
                )}

                <div className="flex gap-2">
                   {task.status !== 'DONE' && (
                     <button 
                       onClick={() => onComplete(task)}
                       className="p-2 rounded-full bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-500 hover:text-white transition-all"
                       title="Complete"
                     >
                       <CheckCircle2 size={16} />
                     </button>
                   )}
                   <button 
                      onClick={() => onDelete(task.id)}
                      className="p-2 rounded-full hover:bg-red-500/20 hover:text-red-500 text-slate-400 transition-all opacity-0 group-hover:opacity-100"
                    >
                      <X size={16} />
                   </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const CreateView = ({ onAddTask }) => {
        const [title, setTitle] = useState('');
        const [priority, setPriority] = useState('MEDIUM');
        const [date, setDate] = useState('');

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!title.trim()) return;
          onAddTask({ title, priority, targetDate: date });
          setTitle('');
          setDate('');
        };

        return (
          <div className="glass-base rounded-3xl p-6 md:p-8 animate-in fade-in zoom-in duration-300">
            <h2 className="text-2xl font-bold mb-6 dark:text-white text-slate-800">New Quest</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-xs font-bold uppercase tracking-wider opacity-60 mb-2 dark:text-white text-slate-700">Quest Title</label>
                <input 
                  type="text" 
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="What needs to be done?"
                  className="w-full bg-transparent border-b-2 border-slate-300 dark:border-white/20 py-3 text-lg focus:outline-none focus:border-indigo-500 transition-colors dark:text-white text-slate-900 placeholder:opacity-30"
                />
              </div>

              <div className="grid grid-cols-2 gap-6">
                <div>
                   <label className="block text-xs font-bold uppercase tracking-wider opacity-60 mb-2 dark:text-white text-slate-700">Priority</label>
                   <div className="flex gap-2">
                     {['LOW', 'MEDIUM', 'HIGH'].map(p => (
                       <button
                         key={p}
                         type="button"
                         onClick={() => setPriority(p)}
                         className={`flex-1 py-2 rounded-xl text-[10px] font-bold border transition-all ${priority === p ? getDifficultyColor(p) : 'border-slate-200 dark:border-white/10 opacity-50 dark:text-white text-slate-600'}`}
                       >
                         {p}
                       </button>
                     ))}
                   </div>
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider opacity-60 mb-2 dark:text-white text-slate-700">Target Date</label>
                  <input 
                    type="date" 
                    value={date}
                    onChange={(e) => setDate(e.target.value)}
                    className="w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl px-3 py-2 dark:text-white text-slate-800 focus:outline-none" 
                  />
                </div>
              </div>

              <button type="submit" className="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl text-white font-bold text-lg shadow-xl shadow-indigo-500/20 active:scale-95 transition-transform hover:brightness-110">
                Initiate Quest
              </button>
            </form>
          </div>
        );
      };

      const KanbanView = ({ tasks, onMoveTask, onUpdateTask, onDeleteTask, onCompleteTask }) => {
        const columns = [
          { id: 'TODO', title: 'To Do', icon: <Circle size={16} /> },
          { id: 'IN_PROGRESS', title: 'Active', icon: <Zap size={16} /> },
          { id: 'DONE', title: 'Done', icon: <CheckCircle2 size={16} /> }
        ];

        const handleDrop = (e, status) => {
           e.preventDefault();
           const taskId = e.dataTransfer.getData("taskId");
           if (taskId) onMoveTask(taskId, status);
        };

        const handleDragOver = (e) => e.preventDefault();

        return (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">
            {columns.map(col => (
              <div 
                key={col.id}
                onDrop={(e) => handleDrop(e, col.id)}
                onDragOver={handleDragOver}
                className="flex flex-col h-full min-h-[500px] glass-base rounded-3xl p-4 transition-colors hover:bg-white/5"
              >
                <div className="flex items-center gap-2 mb-4 px-2 opacity-70 dark:text-white text-slate-800">
                  {col.icon}
                  <span className="font-bold tracking-wide">{col.title}</span>
                  <span className="ml-auto text-xs bg-slate-200 dark:bg-white/10 px-2 py-0.5 rounded-full">{tasks.filter(t => t.status === col.id).length}</span>
                </div>
                <div className="flex-1">
                  {tasks.filter(t => t.status === col.id).map(task => (
                    <TaskCard 
                      key={task.id} 
                      task={task} 
                      onMove={onMoveTask} 
                      onUpdate={onUpdateTask}
                      onDelete={onDeleteTask}
                      onComplete={onCompleteTask}
                    />
                  ))}
                  {tasks.filter(t => t.status === col.id).length === 0 && (
                     <div className="h-24 border-2 border-dashed border-slate-300 dark:border-white/10 rounded-2xl flex items-center justify-center text-xs opacity-30 dark:text-white text-slate-800">
                       Drop here
                     </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        );
      };

      const AchievementsView = ({ user }) => {
        return (
          <div className="space-y-6 animate-in slide-in-from-bottom duration-500">
             <div className="glass-base rounded-3xl p-6 flex items-center justify-around text-center">
                <div>
                  <div className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-amber-400 to-orange-500">{user.streak}</div>
                  <div className="text-xs uppercase tracking-widest opacity-50 dark:text-white text-slate-800">Streak</div>
                </div>
                <div className="w-px h-10 bg-slate-300 dark:bg-white/10"></div>
                <div>
                  <div className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-indigo-400 to-purple-500">{user.tasksCompletedTotal}</div>
                  <div className="text-xs uppercase tracking-widest opacity-50 dark:text-white text-slate-800">Quests</div>
                </div>
                <div className="w-px h-10 bg-slate-300 dark:bg-white/10"></div>
                <div>
                  <div className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-emerald-400 to-cyan-500">{user.credits}</div>
                  <div className="text-xs uppercase tracking-widest opacity-50 dark:text-white text-slate-800">Credits</div>
                </div>
             </div>

             <div className="grid grid-cols-2 gap-4">
               <div className="glass-base rounded-3xl p-6">
                  <h3 className="font-bold mb-4 flex items-center gap-2 dark:text-white text-slate-800"><Flame className="text-orange-500"/> Activity</h3>
                  <div className="space-y-4">
                     <div>
                       <div className="flex justify-between text-xs mb-1 dark:text-white text-slate-600 opacity-80"><span>Level {user.level}</span><span>{user.xp} / {LEVELS[user.level] || LEVELS[LEVELS.length-1]} XP</span></div>
                       <div className="h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden">
                          <div className="h-full bg-indigo-500 transition-all duration-1000" style={{width: `${(user.xp / (LEVELS[user.level] || LEVELS[LEVELS.length-1])) * 100}%`}}></div>
                       </div>
                     </div>
                  </div>
               </div>
               
               <div className="glass-base rounded-3xl p-6">
                  <h3 className="font-bold mb-4 flex items-center gap-2 dark:text-white text-slate-800"><Trophy className="text-yellow-500"/> Badges</h3>
                  <div className="grid grid-cols-3 gap-2">
                     {user.unlockedBadges.map((b, i) => (
                        <div key={i} className="aspect-square rounded-xl bg-gradient-to-br from-yellow-500/20 to-orange-500/20 border border-yellow-500/30 flex items-center justify-center text-2xl" title={b}>
                           üèÜ
                        </div>
                     ))}
                     {Array.from({length: Math.max(0, 6 - user.unlockedBadges.length)}).map((_, i) => (
                        <div key={`locked-${i}`} className="aspect-square rounded-xl bg-black/5 dark:bg-white/5 border border-black/5 dark:border-white/5 flex items-center justify-center grayscale opacity-20">
                           üîí
                        </div>
                     ))}
                  </div>
               </div>
             </div>
          </div>
        );
      };

      const StoreView = ({ user, onBuy, items }) => {
         return (
           <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in duration-300">
             {items.filter(i => !i.unlocked).length === 0 && (
                <div className="col-span-2 text-center py-10 opacity-50 dark:text-white text-slate-800">
                  Store Sold Out! Check Collections.
                </div>
             )}
             {items.filter(i => !i.unlocked).map(item => (
               <div key={item.id} className="glass-base rounded-3xl p-5 flex flex-col items-center text-center relative overflow-hidden group">
                  <div className="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                  
                  <div className="w-16 h-16 rounded-2xl mb-4 shadow-lg flex items-center justify-center text-2xl" style={{
                    background: item.type === 'theme' && item.colors ? `linear-gradient(135deg, ${item.colors[0]}, ${item.colors[1]})` : '#333'
                  }}>
                    {item.type === 'theme' ? 'üé®' : '‚ú®'}
                  </div>
                  
                  <h3 className="font-bold text-lg dark:text-white text-slate-800 relative z-10">{item.name}</h3>
                  <p className="text-xs opacity-60 mb-4 dark:text-white text-slate-600 capitalize relative z-10">{item.type} Upgrade</p>
                  
                  <button 
                    onClick={() => onBuy(item)}
                    disabled={user.credits < item.cost}
                    className="mt-auto px-6 py-2 rounded-xl bg-white dark:bg-white/10 dark:hover:bg-white/20 hover:bg-slate-100 text-sm font-bold transition-colors w-full flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed text-slate-800 dark:text-white relative z-10"
                  >
                    <span>${item.cost}</span>
                  </button>
               </div>
             ))}
           </div>
         );
      };

      const CollectionsView = ({ user, items, onEquip, equippedTheme }) => {
        const ownedItems = items.filter(i => i.unlocked);
        
        return (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in duration-300">
             {ownedItems.length === 0 && <div className="p-8 text-center dark:text-white opacity-50">Nothing here yet. Visit the Store!</div>}
             {ownedItems.map(item => {
               const isEquipped = item.id === equippedTheme.id;
               return (
                 <div key={item.id} className={`glass-base rounded-3xl p-4 flex items-center gap-4 ${isEquipped ? 'ring-2 ring-emerald-500' : ''}`}>
                    <div className="w-12 h-12 rounded-xl flex-shrink-0" style={{
                      background: item.type === 'theme' && item.colors ? `linear-gradient(135deg, ${item.colors[0]}, ${item.colors[1]})` : '#333'
                    }}></div>
                    <div className="flex-1">
                       <h4 className="font-bold dark:text-white text-slate-800">{item.name}</h4>
                       <div className="text-xs opacity-50 dark:text-white text-slate-600">Purchased</div>
                    </div>
                    {item.type === 'theme' && (
                      <button 
                        onClick={() => onEquip(item)}
                        className={`px-4 py-1.5 rounded-lg text-xs font-bold ${isEquipped ? 'bg-emerald-500 text-white' : 'bg-slate-200 dark:bg-white/10 dark:text-white text-slate-800'}`}
                      >
                        {isEquipped ? 'Active' : 'Equip'}
                      </button>
                    )}
                 </div>
               );
             })}
          </div>
        );
      };

      const App = () => {
        // State
        const [activeTab, setActiveTab] = useState('KANBAN'); 
        const [darkMode, setDarkMode] = useState(true);
        const [tasks, setTasks] = useState([]);
        const [storeItems, setStoreItems] = useState(ITEMS_DB);
        const [equippedTheme, setEquippedTheme] = useState(ITEMS_DB[0]);
        const [isLoading, setIsLoading] = useState(true);
        
        const [user, setUser] = useState({
          xp: 0,
          level: 1,
          credits: 0,
          streak: 1,
          tasksCompletedTotal: 0,
          unlockedBadges: [],
        });

        // Load Data from IndexedDB
        useEffect(() => {
          const loadData = async () => {
            try {
              await idb.init();
              
              const savedTasks = await idb.get('tasks');
              const savedUser = await idb.get('user');
              const savedTheme = await idb.get('theme');
              const savedItems = await idb.get('items');
              
              if (savedTasks) setTasks(savedTasks);
              if (savedUser) setUser(savedUser);
              if (savedTheme) setEquippedTheme(savedTheme);
              
              // Smart merge for items: preserve unlocking but allow new items from code to appear
              if (savedItems) {
                const mergedItems = ITEMS_DB.map(staticItem => {
                   const savedItem = savedItems.find(i => i.id === staticItem.id);
                   return savedItem ? { ...staticItem, unlocked: savedItem.unlocked } : staticItem;
                });
                setStoreItems(mergedItems);
              } else {
                setStoreItems(ITEMS_DB);
              }
            } catch (e) {
              console.error("Failed to load data from IndexedDB", e);
            } finally {
              setIsLoading(false);
            }
          };
          loadData();
        }, []);

        // Save Data to IndexedDB (Debounced or on change)
        useEffect(() => { if (!isLoading) idb.set('tasks', tasks); }, [tasks, isLoading]);
        useEffect(() => { if (!isLoading) idb.set('user', user); }, [user, isLoading]);
        useEffect(() => { if (!isLoading) idb.set('theme', equippedTheme); }, [equippedTheme, isLoading]);
        useEffect(() => { if (!isLoading) idb.set('items', storeItems); }, [storeItems, isLoading]);

        // Logic
        const addTask = (taskData) => {
          const newTask = {
            id: Date.now().toString(),
            status: 'TODO',
            createdAt: Date.now(),
            isTimerRunning: false,
            elapsedTime: 0,
            ...taskData
          };
          setTasks([newTask, ...tasks]);
          setActiveTab('KANBAN');
        };

        const updateTask = (id, updates) => {
          setTasks(prev => prev.map(t => t.id === id ? { ...t, ...updates } : t));
        };

        const moveTask = (id, newStatus) => {
          const task = tasks.find(t => t.id === id);
          if(task && task.status !== newStatus) {
            updateTask(id, { status: newStatus });
            if (newStatus === 'DONE' && task.status !== 'DONE') {
               completeTaskEffect(task);
            }
          }
        };

        const deleteTask = (id) => {
          setTasks(prev => prev.filter(t => t.id !== id));
        };

        const completeTaskEffect = (task) => {
           let xpGain = 100;
           if (task.priority === 'HIGH') xpGain += 50;
           
           setUser(prev => ({
             ...prev,
             xp: prev.xp + xpGain,
             credits: prev.credits + xpGain,
             tasksCompletedTotal: prev.tasksCompletedTotal + 1,
             level: LEVELS.findIndex(l => (prev.xp + xpGain) < l) || prev.level
           }));

           if (window.confetti) {
             const colors = equippedTheme && equippedTheme.colors ? equippedTheme.colors : ['#ffffff'];
             window.confetti({
               particleCount: 100,
               spread: 70,
               origin: { y: 0.6 },
               colors: colors
             });
           }
        };

        const buyItem = (item) => {
           if (user.credits >= item.cost) {
             setUser(prev => ({ ...prev, credits: prev.credits - item.cost }));
             setStoreItems(prev => prev.map(i => i.id === item.id ? { ...i, unlocked: true } : i));
             if(item.type === 'theme') setEquippedTheme(item);
             alert(`Purchased ${item.name}!`);
           }
        };

        const tabs = [
          { id: 'CREATE', icon: <Plus size={20} />, label: 'New' },
          { id: 'KANBAN', icon: <Layers size={20} />, label: 'Board' },
          { id: 'ACHIEVEMENTS', icon: <Trophy size={20} />, label: 'Stats' },
          { id: 'STORE', icon: <ShoppingBag size={20} />, label: 'Store' },
          { id: 'COLLECTIONS', icon: <Sparkles size={20} />, label: 'Items' },
        ];

        return (
          <Layout darkMode={darkMode} setDarkMode={setDarkMode} user={user} equippedTheme={equippedTheme} isLoading={isLoading}>
             <main className="flex-1 overflow-visible relative">
                {activeTab === 'CREATE' && <CreateView onAddTask={addTask} />}
                {activeTab === 'KANBAN' && (
                  <KanbanView 
                    tasks={tasks} 
                    onMoveTask={moveTask} 
                    onUpdateTask={updateTask} 
                    onDeleteTask={deleteTask}
                    onCompleteTask={(t) => moveTask(t.id, 'DONE')}
                  />
                )}
                {activeTab === 'ACHIEVEMENTS' && <AchievementsView user={user} />}
                {activeTab === 'STORE' && <StoreView user={user} items={storeItems} onBuy={buyItem} />}
                {activeTab === 'COLLECTIONS' && <CollectionsView user={user} items={storeItems} onEquip={setEquippedTheme} equippedTheme={equippedTheme} />}
             </main>

             <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md glass-base rounded-full p-2 flex justify-between items-center z-50">
                {tabs.map(tab => {
                  const isActive = activeTab === tab.id;
                  return (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`flex flex-col items-center justify-center w-14 h-14 rounded-full transition-all duration-300 ${
                        isActive 
                        ? 'bg-slate-800 text-white dark:bg-white dark:text-slate-900 shadow-lg scale-110' 
                        : 'text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-white/10'
                      }`}
                    >
                      {tab.icon}
                    </button>
                  );
                })}
             </nav>
          </Layout>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>